package ExploitCam;

import java.io.IOException;

import camOperations.Cam;
import camOperations.FaceDetector;

public class CamWork {

    public static final int SLEEP_TIME = 1000;
    public int missAcceptedTime;

    private Cam cam = Cam.getInstance();
    private FaceDetector faceDetector = FaceDetector.getInstance();

    private int missDetect;
    private boolean inDetection;
    private boolean continueDetection;

    public CamWork() {
	missAcceptedTime = 5000;
	missDetect = 0;
	inDetection = false;
	continueDetection = true;
    }

    public CamWork(int acceptedTime) {
	missAcceptedTime = acceptedTime;
	missDetect = 0;
	inDetection = false;
	continueDetection = true;
    }

    public void run() {
	while (cam.getCapture().isOpened() && continueDetection) {
	    work();
	    sleep();
	    updateContinueDetection();
	}
	cam.getCapture().release();
	makeAction();
    }

    public void setMissAcceptedTime(int missAcceptedTime) {
	this.missAcceptedTime = missAcceptedTime;
    }

    private void work() {
	if (cam.read()) {
	    if (faceDetector.detectFace(cam.getFrame())) {// face(s) Detected
		if (missDetect != 0) {
		    missDetect = 0;
		}
		if (!inDetection) {// First detection
		    inDetection = true;
		}
	    } else {// if in detection and miss Detect face ==> count
		if (inDetection) {
		    ++missDetect;
		}
	    }
	} else {
	    System.out.println("Error Reading");
	}
    }

    public void sleep() {
	try {
	    Thread.sleep(SLEEP_TIME);
	} catch (InterruptedException e) {
	    e.printStackTrace();
	}
    }

    private void updateContinueDetection() {
	continueDetection = missAcceptedTime > SLEEP_TIME * missDetect;
    }

    private void makeAction() {
	Runtime r = Runtime.getRuntime();
	String osName = System.getProperty("os.name");
	if (osName.startsWith("Win")) {
	    try {
		r.exec("shutdown.exe -l");
	    } catch (IOException e) {
		// TODO Auto-generated catch block
		e.printStackTrace();
	    }
	} else if (osName.startsWith("Linux") || osName.startsWith("Mac")) {
	    try {
		r.exec("shutdown -l now");
	    } catch (IOException e) {
		// TODO Auto-generated catch block
		e.printStackTrace();
	    }
	}
	System.out.println("Logging out session");
    }
}
